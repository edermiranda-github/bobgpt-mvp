<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casei com a Garota da Capa - Compartilhe seu Feedback</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e0f2f7; /* Azul claro */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .book-info {
            flex: 1;
            min-width: 300px;
            padding: 40px;
            background: linear-gradient(135deg, #81d4fa, #4fc3f7); /* Gradiente azul c√©u */
            color: #fff;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .book-info h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .book-info p {
            font-size: 1.2em;
            max-width: 500px;
            opacity: 0.9;
        }

        .book-cover {
            width: 200px;
            height: 300px;
            background-color: #66bb6a; /* Verde claro */
            border-radius: 10px;
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            font-weight: 700;
            color: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .book-cover span {
            display: block;
            text-align: center;
            padding: 5px;
        }

        .book-cover span:first-child {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .content-section {
            flex: 1;
            min-width: 300px;
            padding: 40px;
            background-color: #fff;
        }

        .content-section h2 {
            font-size: 1.8em;
            color: #29b6f6; /* Azul vibrante */
            margin-bottom: 20px;
            border-bottom: 2px solid #e0f2f7;
            padding-bottom: 10px;
        }

        .chat-container {
            border: 1px solid #e0f2f7;
            border-radius: 10px;
            padding: 20px;
            background-color: #f5f5f5;
            height: 500px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.95em;
        }

        .message.bot {
            background-color: #e0f7fa; /* Azul claro */
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message.user {
            background-color: #bbdefb; /* Azul mais escuro */
            align-self: flex-end;
            text-align: right;
            border-bottom-right-radius: 5px;
        }

        .chat-input {
            padding-top: 15px;
            border-top: 1px solid #e0f2f7;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .language-selector, .rating-buttons, .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .lang-btn, .rating-btn, .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .lang-btn {
            background-color: #29b6f6; /* Azul vibrante */
            color: white;
        }

        .lang-btn:hover {
            background-color: #0288d1;
            transform: translateY(-2px);
        }

        .lang-btn.selected {
            background-color: #0288d1;
            border: 2px solid #0288d1;
            transform: translateY(-2px);
        }

        .rating-btn {
            background-color: #81d4fa; /* Azul claro */
            color: #333;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
        }

        .rating-btn:hover {
            background-color: #4fc3f7;
            transform: translateY(-2px);
        }

        .rating-btn.selected {
            background-color: #4fc3f7;
            border: 2px solid #0288d1;
            transform: translateY(-2px);
        }

        textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            resize: vertical;
            min-height: 60px;
            font-family: 'Roboto', sans-serif;
            font-size: 1em;
        }

        .btn-primary {
            background-color: #4CAF50; /* Verde */
            color: white;
        }

        .btn-primary:hover {
            background-color: #388E3C;
        }

        .btn-secondary {
            background-color: #ff9800; /* Laranja */
            color: white;
        }

        .btn-secondary:hover {
            background-color: #f57c00;
        }

        .hidden {
            display: none;
        }

        #audioStatus {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                width: 100%;
                margin: 0;
                border-radius: 0;
            }

            .book-info, .content-section {
                padding: 20px;
                min-width: unset;
            }

            .book-info h1 {
                font-size: 2em;
            }

            .book-info p {
                font-size: 1em;
            }

            .chat-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="book-info">
            <h1>Casei com a Garota da Capa</h1>
            <p>Uma jornada extraordin√°ria</p>
            <div class="book-cover">
                <span>Casei com a</span>
                <span>Garota da Capa</span>
                <span>Uma jornada extraordin√°ria</span>
            </div>
            <p>Convido voc√™ a se acomodar em uma cadeira confort√°vel e embarcar comigo nesta viagem extraordin√°ria. Aqui compartilho n√£o apenas uma hist√≥ria, mas um tesouro sagrado - os fios dourados que o Universo teceu em minha jornada.</p>
        </div>
        <div class="content-section">
            <h2>üí¨ Compartilhe seu Feedback</h2>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        Sauda√ß√µes! / Greetings! üëã
                        <div style="margin-top: 10px;">
                            Por favor, selecione seu idioma / Please select your language:
                        </div>
                        <div class="language-selector">
                            <button class="lang-btn" onclick="selectLanguage('pt', this)">üáßüá∑ Portugu√™s</button>
                            <button class="lang-btn" onclick="selectLanguage('en', this)">üá∫üá∏ English</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input" id="chatInput">
                <!-- Input ser√° gerado dinamicamente -->
            </div>
        </div>
    </div>

    <script>
        // Estado do chatbot
        let chatState = {
            language: null,
            currentStep: 'language',
            responses: {
                timestamp: new Date().toISOString(),
                language: null,
                coverRating: null,
                titleRating: null,
                storyRating: null,
                recommendationRating: null,
                feedbackText: '',
                feedbackAudio: null
            }
        };

        // Textos em diferentes idiomas
        const texts = {
            pt: {
                welcome: "Feliz em compartilhar com voc√™ as primeiras impress√µes sobre o nosso livro 'Casei com a Garota da Capa'.",
                coverQuestion: "De 0 a 5 - a capa √© bonita?",
                titleQuestion: "De 0 a 5 - o t√≠tulo me chama a aten√ß√£o?",
                storyQuestion: "De 0 a 5 - √© uma hist√≥ria inspiradora?",
                recommendationQuestion: "De 0 a 5 - recomendaria a compra para um amigo?",
                feedbackQuestion: "Compartilhe suas impress√µes e feedbacks (deixe um texto ou grave um √°udio):",
                textPlaceholder: "Digite seu feedback aqui...",
                sendText: "Enviar Texto",
                recordAudio: "Gravar √Åudio",
                stopRecording: "Parar Grava√ß√£o",
                sendAudio: "Enviar √Åudio",
                sending: "Enviando...",
                thankYou: "Obrigado pelo seu feedback! Suas impress√µes s√£o muito valiosas para n√≥s.",
                error: "Erro ao enviar feedback. Tente novamente.",
                selectRating: "Por favor, selecione uma nota de 0 a 5"
            },
            en: {
                welcome: "Happy to share with you the first impressions about our book 'Married the Cover Girl'.",
                coverQuestion: "From 0 to 5 - is the cover beautiful?",
                titleQuestion: "From 0 to 5 - does the title catch your attention?",
                storyQuestion: "From 0 to 5 - is it an inspiring story?",
                recommendationQuestion: "From 0 to 5 - would you recommend buying it to a friend?",
                feedbackQuestion: "Share your impressions and feedback (leave a text or record an audio):",
                textPlaceholder: "Type your feedback here...",
                sendText: "Send Text",
                recordAudio: "Record Audio",
                stopRecording: "Stop Recording",
                sendAudio: "Send Audio",
                sending: "Sending...",
                thankYou: "Thank you for your feedback! Your impressions are very valuable to us.",
                error: "Error sending feedback. Please try again.",
                selectRating: "Please select a rating from 0 to 5"
            }
        };

        // Vari√°veis para grava√ß√£o de √°udio
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.innerHTML = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function selectLanguage(lang, element) {
            console.log('selectLanguage called with:', lang, element);
            chatState.language = lang;
            chatState.responses.language = lang;
            
            // Marcar bot√£o selecionado
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            
            // Adicionar resposta do usu√°rio
            addMessage('user', lang === 'pt' ? 'Portugu√™s' : 'English');
            
            // Pr√≥xima mensagem do bot
            setTimeout(() => {
                addMessage('bot', texts[lang].welcome);
                chatState.currentStep = 'coverRating';
                setTimeout(() => {
                    askRating('coverRating');
                }, 1000);
            }, 500);
        }

        function askRating(step) {
            console.log('askRating called with:', step);
            const lang = chatState.language;
            let question = '';
            
            switch(step) {
                case 'coverRating':
                    question = texts[lang].coverQuestion;
                    break;
                case 'titleRating':
                    question = texts[lang].titleQuestion;
                    break;
                case 'storyRating':
                    question = texts[lang].storyQuestion;
                    break;
                case 'recommendationRating':
                    question = texts[lang].recommendationQuestion;
                    break;
            }
            
            addMessage('bot', question);
            showRatingButtons(step);
        }

        function showRatingButtons(step) {
            console.log('showRatingButtons called with:', step);
            const chatInput = document.getElementById('chatInput');
            chatInput.innerHTML = `
                <div class="rating-buttons">
                    ${[0,1,2,3,4,5].map(num => 
                        `<button class="rating-btn" onclick="selectRating('${step}', ${num}, this)">${num}</button>`
                    ).join('')}
                </div>
                <p style="text-align: center; color: #666; font-size: 0.9em; margin-top: 10px;">
                    ${texts[chatState.language].selectRating}
                </p>
            `;
        }

        function selectRating(step, rating, element) {
            console.log('selectRating called with:', step, rating, element);
            chatState.responses[step] = rating;
            
            // Marcar bot√£o selecionado
            document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            
            // Adicionar resposta do usu√°rio
            addMessage('user', `${rating}/5`);
            
            // Pr√≥ximo passo
            setTimeout(() => {
                switch(step) {
                    case 'coverRating':
                        chatState.currentStep = 'titleRating';
                        askRating('titleRating');
                        break;
                    case 'titleRating':
                        chatState.currentStep = 'storyRating';
                        askRating('storyRating');
                        break;
                    case 'storyRating':
                        chatState.currentStep = 'recommendationRating';
                        askRating('recommendationRating');
                        break;
                    case 'recommendationRating':
                        chatState.currentStep = 'feedback';
                        askFeedback();
                        break;
                }
            }, 500);
        }

        function askFeedback() {
            console.log('askFeedback called');
            const lang = chatState.language;
            addMessage('bot', texts[lang].feedbackQuestion);
            showFeedbackInput();
        }

        function showFeedbackInput() {
            console.log('showFeedbackInput called');
            const lang = chatState.language;
            const chatInput = document.getElementById('chatInput');
            chatInput.innerHTML = `
                <div class="input-group">
                    <textarea id="feedbackText" placeholder="${texts[lang].textPlaceholder}"></textarea>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="sendTextFeedback()">
                        ${texts[lang].sendText}
                    </button>
                    <button class="btn btn-secondary" id="audioBtn" onclick="toggleAudioRecording()">
                        ${texts[lang].recordAudio}
                    </button>
                </div>
                <div id="audioStatus" class="hidden"></div>
            `;
        }

        async function sendTextFeedback() {
            console.log('sendTextFeedback called');
            const feedbackText = document.getElementById('feedbackText').value.trim();
            if (!feedbackText) return;
            
            chatState.responses.feedbackText = feedbackText;
            addMessage('user', feedbackText);
            
            await sendFeedbackToN8n();
        }

        async function toggleAudioRecording() {
            console.log('toggleAudioRecording called');
            const audioBtn = document.getElementById('audioBtn');
            const audioStatus = document.getElementById('audioStatus');

            if (!isRecording) {
                // Iniciar grava√ß√£o
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        chatState.responses.feedbackAudio = audioBlob;
                        addMessage('user', '√Åudio gravado.');
                        await sendFeedbackToN8n();
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    audioBtn.textContent = texts[chatState.language].stopRecording;
                    audioBtn.classList.remove('btn-secondary');
                    audioBtn.classList.add('btn-primary');
                    audioStatus.textContent = 'Gravando...';
                    audioStatus.classList.remove('hidden');
                } catch (error) {
                    console.error('Erro ao acessar microfone:', error);
                    audioStatus.textContent = 'Erro ao acessar microfone. Verifique as permiss√µes.';
                    audioStatus.classList.remove('hidden');
                }
            } else {
                // Parar grava√ß√£o
                mediaRecorder.stop();
                isRecording = false;
                audioBtn.textContent = texts[chatState.language].recordAudio;
                audioBtn.classList.remove('btn-primary');
                audioBtn.classList.add('btn-secondary');
                audioStatus.textContent = '';
                audioStatus.classList.add('hidden');
            }
        }

        async function sendFeedbackToN8n() {
            console.log('sendFeedbackToN8n called');
            const lang = chatState.language;
            const chatInput = document.getElementById('chatInput');
            chatInput.innerHTML = `<div class="message bot">${texts[lang].sending}</div>`;

            const formData = new FormData();
            for (const key in chatState.responses) {
                if (chatState.responses[key] !== null && chatState.responses[key] !== '') {
                    if (key === 'feedbackAudio' && chatState.responses[key] instanceof Blob) {
                        formData.append(key, chatState.responses[key], 'audio.webm');
                    } else {
                        formData.append(key, chatState.responses[key]);
                    }
                }
            }

            try {
                const response = await fetch('https://bobgpt.app.n8n.cloud/webhook/feedback-webhook', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    addMessage('bot', texts[lang].thankYou);
                    // Resetar estado para permitir novo feedback
                    chatState.responses = {
                        timestamp: new Date().toISOString(),
                        language: null,
                        coverRating: null,
                        titleRating: null,
                        storyRating: null,
                        recommendationRating: null,
                        feedbackText: '',
                        feedbackAudio: null
                    };
                    chatState.currentStep = 'language';
                    setTimeout(() => {
                        document.getElementById('chatMessages').innerHTML = `
                            <div class="message bot">
                                Sauda√ß√µes! / Greetings! üëã
                                <div style="margin-top: 10px;">
                                    Por favor, selecione seu idioma / Please select your language:
                                </div>
                                <div class="language-selector">
                                    <button class="lang-btn" onclick="selectLanguage('pt', this)">üáßüá∑ Portugu√™s</button>
                                    <button class="lang-btn" onclick="selectLanguage('en', this)">üá∫üá∏ English</button>
                                </div>
                            </div>
                        `;
                        document.getElementById('chatInput').innerHTML = '';
                    }, 2000);
                } else {
                    addMessage('bot', texts[lang].error);
                    console.error('Erro na resposta do webhook:', response.status, response.statusText);
                }
            } catch (error) {
                addMessage('bot', texts[lang].error);
                console.error('Erro ao enviar feedback:', error);
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            // O estado inicial j√° √© 'language', ent√£o n√£o precisamos chamar nada aqui.
            // A primeira mensagem j√° est√° no HTML.
        });
    </script>
</body>
</html>

